(function(d){function M(a){a="useCanvasRenderer"===a||"useWebGLRenderer"===a?document.createElement("canvas"):document.createElement("div");a.width=a.height=0;return a}function h(){this.lwfInstances={};this.lwfLoaderUid=0;this.timers={};this.initializeHooks=[];this.requests=[];this.pausing=!1;this.loadingCounter=0;this.debug=!1;this.resizeMode=this.backgroundColor=null;this.fitToScreen=!1;this.displayDivId=null;this.screenHeight=this.screenWidth=this.stageHeight=this.stageWidth=0;this.stageVAlign=
this.stageHAlign=-1;this.useAbsImagePath=this.useWebGL=this.useLargeImage=!1;this.isPreventDefaultEnabled=F||/Android *(4|3)\..*/.test(m);this.rootOffset={x:0,y:0};var a=null,d=0;this.getRenderer=function(){return a};this.setRenderer=function(f){if(a)throw Error("cannot use multiple renderer! LWF has been initialized for "+a+" renderer.");"canvas"===f?f="useCanvasRenderer":"webkitcss"===f?f="useWebkitCSSRenderer":"webgl"===f&&(f="useWebGLRenderer");f&&f.match(/use.+Renderer/i)&&(a=f)};this.getCurrentFPS=
function(){isNaN(d)&&console.error("[LWF] FPS is not properly defined");return d};this.setCurrentFPS=function(a){isNaN(a)&&console.error("[LWF] FPS is not properly defined");d=a};return this}var m=navigator.userAgent,F=/iP(ad|hone|od)/.test(m),y=/Android/.test(m),v=F||y,J=/Chrome/.test(m),z=!y||J,B=0;"undefined"===typeof d.performance&&(d.performance={});d.performance.now=d.performance.now||d.performance.webkitNow||d.performance.mozNow||d.performance.oNow||d.performance.msNow||Date.now;d.requestAnimationFrame=
d.requestAnimationFrame||d.webkitRequestAnimationFrame||d.mozRequestAnimationFrame||d.oRequestAnimationFrame||d.msRequestAnimationFrame;d.cancelAnimationFrame=d.cancelAnimationFrame||d.webkitCancelAnimationFrame||d.mozCancelAnimationFrame||d.oCancelAnimationFrame||d.msCancelAnimationFrame;(void 0===d.requestAnimationFrame||/iP(ad|hone|od).*OS 6/.test(m))&&function(){var a=1E3/60,p=d.performance.now();d.requestAnimationFrame=function(f){var g=d.performance.now()-p;return d.setTimeout(function(){p=
d.performance.now();f()},a-(g>a?g%a:g))};d.cancelAnimationFrame=function(a){return d.clearTimeout(a)}}();h.prototype.isLwfsEnvironment_=function(){return d.testlwf_settings&&!this.isLwfsLoaderEnvironment_()};h.prototype.isLwfsLoaderEnvironment_=function(){return d.lwfs_loader_mode};h.prototype.setPreventDefaultBehaviour=function(a){this.isPreventDefaultEnabled=a};h.prototype.addInitializeHook=function(a){_.isFunction(a)&&this.initializeHooks.push(a)};h.prototype.pause=function(){this.pausing=!0};
h.prototype.resume=function(){this.pausing=!1};h.prototype.getLwfMapper_=function(a){if(null===a.lwfMap)return _.bind(this.getLwfPath_,this);var d=a.lwfMap;if(_.isObject(d))return _.isFunction(d)?d:function(a){var g=a;d.hasOwnProperty(a)&&(g=d[a]);/\.lwf$/.test(g)||(g+=".lwf");return g};throw Error("unsupported lwfMap");};h.prototype.getLwfPath_=function(a){var d=a;0<=a.indexOf("/")&&(d=a.substring(a.lastIndexOf("/")+1));return this.isLwfsEnvironment_()||this.isLwfsLoaderEnvironment_()?d+".lwf":a+
"/_/"+d+".lwf"};h.prototype.getImageMapper_=function(a){return _.isFunction(a)?a:function(d){return a[d]?a[d]:d}};h.prototype.autoSelectRenderer_=function(){if(this.useWebGL)for(var a=document.createElement("canvas"),d=["webgl","experimental-webgl","moz-webgl","webkit-3d"],f,g=0;g<d.length;g++)if(f=a.getContext(d[g]))return"useWebGLRenderer";return/iP(ad|hone|od).*OS 4/.test(m)||/Android 2\.1/.test(m)||/Android 2\.3\.[5-7]/.test(m)||/Android 4/.test(m)&&!/Chrome/.test(m)?"useWebkitCSSRenderer":"useCanvasRenderer"};
h.prototype.setDisplaySetting=function(a){a.renderer&&this.setRenderer(a.renderer);this.resizeMode=a.resizeMode||this.resizeMode;this.displayDivId=a.displayDivId||this.displayDivId;this.stageWidth=a.stageWidth||this.stageWidth;this.stageHeight=a.stageHeight||this.stageHeight;this.screenWidth=a.screenWidth||this.screenWidth;this.screenHeight=a.screenHeight||this.screenHeight;this.stageHAlign="undefined"!==typeof a.stageHAlign?a.stageHAlign:this.stageHAlign;this.stageVAlign="undefined"!==typeof a.stageHAlign?
a.stageVAlign:this.stageVAlign;this.useLargeImage=a.useLargeImage||this.useLargeImage};h.prototype.handleException_=function(a,d){var f=d.pageTransitionMap,g=null;f.hasOwnProperty("error")?g=f.error:0<_.size(f)&&(g=_.find(f,function(){return!0}));f=d.handler;null===f||void 0===f.exception?confirm("LWF exception. \n"+a.stack+"\n reload?")&&location.reload():_.isFunction(f.exception)&&f.exception(a,g);console.error("[LWF] exception: %s",a.stack)};h.prototype.handleLoadError_=function(a,d){var f=d.pageTransitionMap,
g=null;f.hasOwnProperty("error")?0<_.size(f)&&(g=_.find(f,function(){return!0})):g=f.error;f=d.handler;null===f||void 0===f.loadError?confirm("LWF load error. \n reload?")&&location.reload():_.isFunction(f.loadError)&&f.loadError(a,g);console.error("[LWF] load error: %o",a.error);console.error("[LWF] loaded count: %d/%d",a.loadedCount,a.total)};h.prototype.onLoad=function(a){var p=a.privateData,f=p.lwfLoader;f.lwfInstances[f.lwfLoaderUid]=a;p.loaderUid=f.lwfLoaderUid++;var g=this,b=g.privateData._loaderData,
c=b.loader,e=b.stageEventReceiver;g.privateData=null;if(a){if(_.isFunction(b.callback.onLoad))b.callback.onLoad(a);var l,h,x,A,K,k=this.stage,z=0,B=0,w=1,r=0,t=0,G=d.performance.now(),H=0,L=G,I=0;a.rootMovie.moveTo(c.rootOffset.x,c.rootOffset.y);d.lwfs_loader_mode||(a.width=c.stageWidth?c.stageWidth:a.width,a.height=c.stageHeight?c.stageHeight:a.height);d.lwfWidth=a.width;d.lwfHeight=a.height;var D=d.devicePixelRatio;"useWebkitCSSRenderer"===c.getRenderer()&&(D=1);"useWebGLRenderer"===c.getRenderer()&&
/ F-/.test(m)&&(D=2);"useWebkitCSSRenderer"===c.getRenderer()&&/Android 2\.3\.[5-7]/.test(m)&&/SH/.test(m)&&(this.stage.style.opacity=.9999);l=function(){try{if(a){var f=c.stageWidth?c.stageWidth:a.width,u=c.stageHeight?c.stageHeight:a.height,q=c.screenWidth?c.screenWidth:d.innerWidth,h=c.screenHeight?c.screenHeight:d.innerHeight,p=q/h,A=f/u;y&&(d.innerWidth>d.screen.width&&(q=d.screen.width),d.innerHeight>d.screen.height&&(h=d.screen.height));if(z!==q||B!==h){r=f;t=u;g.fitForWidth?(r=Math.round(q),
t=Math.round(q*u/f)):g.fitForHeight?(r=Math.round(h*f/u),t=Math.round(h)):b.fitToScreen&&(p>A?(r=h/u*f,t=h):(r=q,t=q/f*u));u=f=0;f=-1==c.stageHAlign?0:1==c.stageHAlign?Math.round(q-r):Math.round((q-r)/2);u=-1==c.stageVAlign?0:1==c.stageVAlign?Math.round(h-t):Math.round((h-t)/2);k.width=c.stageWidth?c.stageWidth:k.width;k.height=c.stageHeight?c.stageHeight:k.height;e.style.left=k.style.left=f+"px";e.style.top=k.style.top=u+"px";e.style.width=k.style.width=r+"px";e.style.height=k.style.height=t+"px";
e.width=k.width=Math.floor(r*D);e.height=k.height=Math.floor(t*D);b.fitToScreen?p<A?(w=r/k.width,a.property.clear(),a.fitForWidth(k.width,k.height)):(w=t/k.height,a.property.clear(),a.fitForHeight(k.width,k.height)):g.fitForWidth?(w=r/k.width,a.property.clear(),a.fitForWidth(k.width,k.height)):(w=t/k.height,a.property.clear(),a.fitForHeight(k.width,k.height));"useWebkitCSSRenderer"===c.getRenderer()&&a.setTextScale(window.devicePixelRatio);a.property.moveTo(0,0);if(c.displayDivId){var m=document.getElementById(c.displayDivId);
b.fitToScreen?(m.style.width=q+"px",m.style.height=h+"px"):(m.style.width=r+"px",m.style.height=t+"px")}z=q;B=h}var n=d.performance.now(),q=n-G;G=n;c.pausing||(a.exec(q/1E3),a.render());var x=a.privateData;x.lwfLoader.timers[x.lwfLoaderUid]=d.requestAnimationFrame(l);0===H%60&&(I=Math.round(6E4/(n-L)),L=n,H=0);if(c.debug||b.debug)document.getElementById("lwf_info"+b.debugInfoElementId).innerHTML=I+"fps";H++;c.setCurrentFPS(I)}}catch(v){c.handleException_(v,b)}};h=function(d){try{if(c.isPreventDefaultEnabled&&
d.preventDefault(),a){var e,f,g=k.getBoundingClientRect();if(v){var h=d.touches[0];e=h.pageX;f=h.pageY}else e=d.clientX,f=d.clientY;v?(e=e-g.left-window.scrollX,f=f-g.top-window.scrollY):(e-=g.left,f-=g.top);e/=w;f/=w;a.inputPoint(e,f)}}catch(p){c.handleException_(p,b)}};x=function(d){try{if(c.isPreventDefaultEnabled&&d.preventDefault(),a){var e,f,g=k.getBoundingClientRect();if(v){var h=d.touches[0];e=h.pageX;f=h.pageY}else e=d.clientX,f=d.clientY;v?(e=e-g.left-window.scrollX,f=f-g.top-window.scrollY):
(e-=g.left,f-=g.top);e/=w;f/=w;a.inputPoint(e,f);a.inputPress()}}catch(p){c.handleException_(p,b)}};A=function(d){try{c.isPreventDefaultEnabled&&d.preventDefault(),a&&a.inputRelease()}catch(e){c.handleException_(e,b)}};K=function(e){try{a&&d.location.reload(!0)}catch(f){c.handleException_(f,b)}};f.timers[p.lwfLoaderUid]=d.requestAnimationFrame(l);v?(y&&(J||/ SC-0/.test(m))&&document.body.addEventListener("touchstart",function(){}),F&&(c.debug||b.debug)&&e.addEventListener("gestureend",K,!1),e.addEventListener("touchmove",
h,!1),e.addEventListener("touchstart",x,!1),e.addEventListener("touchend",A,!1)):(e.addEventListener("mousemove",h,!1),e.addEventListener("mousedown",x,!1),e.addEventListener("mouseup",A,!1));_.each(b.buttonEventMap,function(b,c){_.isFunction(b)?b={release:b}:_.each(b,function(a,b){if(!_.isFunction(a))throw Error("button event ["+b+"@"+c+"] is not a function!");});a.setButtonEventHandler(c,b)});var C={},E=function(a,b){C.hasOwnProperty(a)||(C[a]=[]);C[a].push(b)};_.isObject(b.fsCommandMap)&&_.each(b.fsCommandMap,
function(a,b){_.isFunction(a)&&E(b,a)});_.isObject(b.pageTransitionMap)&&_.each(b.pageTransitionMap,function(a,b){_.isString(a)?E(b,function(){document.location.href=a}):_.isFunction(a)&&E(b,function(){a(b)})});E=null;_.each(C,function(b,c){a.setEventHandler(c,function(a,c){for(var d=b.length,e=0;e<d;++e)b[e](a,c)})});C=null}else c.handleLoadError_(this,b)};h.prototype.playLWF=function(a,h){var f=a.getAttribute("data-lwf-display_setting");f&&(f=JSON.parse(f),this.setDisplaySetting(f));f=d.LWF;this.getRenderer()||
this.setRenderer(this.autoSelectRenderer_());var g=this.getRenderer();if(g)f[g]();else throw Error("Renderer parameters are not properly set");f=f.ResourceCache.get();this.debug&&(d.LWFLOADER_ENABLE_DEBUG=!0);var b={};b.onload=this.onLoad;this.backgroundColor?b.setBackgroundColor=this.backgroundColor:b.useBackgroundColor=!0;b.fitForHeight=!1;b.fitForWidth=!1;"fitForWidth"===this.resizeMode?b.fitForWidth=!0:"fitForHeight"===this.resizeMode?b.fitForHeight=!0:"fitToScreen"===this.resizeMode&&(this.fitToScreen=
!0);b.fitToScreen=this.fitToScreen;b.worker=z;y&&/ (SC-0|Galaxy Nexus|SH-0)/.test(m)&&"useWebkitCSSRenderer"===g&&(b.quirkyClearRect=!0);y&&(b.use3D=!1);b.privateData={};b.pos=null;b.imageMap={};b.soundMap={};b.pageTransitionMap={};b.buttonEventMap={};b.fsCommandMap={};b.handler={};b.callback={};b.lwfMap=null;for(var c=function(a){return a.charAt(1).toUpperCase()},e=0;e<a.attributes.length;e++){var l=a.attributes[e];if(l.name&&0===l.name.indexOf("data-lwf-")){var n=l.name.slice(9),n=n.replace(/_./g,
c);if("displaySetting"!==n){l=l.value;try{"{"===l.charAt(0)&&(l=JSON.parse(l))}catch(x){}b[n]=l}}}2===d.devicePixelRatio&&this.useLargeImage&&(b.imageSuffix="_@2x");b.hasOwnProperty("lwf")||(c=a.getAttribute("data-lwf"),_.isString(c)&&(b.lwf=c));b.hasOwnProperty("name")&&(b.lwf=b.name);_.isObject(h)&&_.extend(b,h);0<this.initializeHooks.length&&_.each(this.initializeHooks,_.bind(function(c){if(_.isFunction(c)){c=c.call(this,a);for(var e in c)c.hasOwnProperty(e)&&_.extend(b[e],c[e])}},this));this.initializeHooks=
[];if(!b.hasOwnProperty("lwf"))throw Error("[LWF] no LWF input");c={};c.debugInfoElementId=++B;c.setting=b;c.loader=this;c.debug=!1;c.soundMap=null;c.pageTransitionMap=null;c.buttonEventMap=null;c.fsCommandMap=null;c.handler=null;c.callback=null;c.stageEventReceiver=null;c.lwfMap=null;c.debug=this.debug;b.privateData.hasOwnProperty("lwfLoader")||(b.privateData.lwfLoader=this);b.imageMap=this.getImageMapper_(b.imageMap);_.isEmpty(b.soundMap)||(c.soundMap=b.soundMap);delete b.soundMap;_.isObject(b.pageTransitionMap)&&
(c.pageTransitionMap=b.pageTransitionMap);delete b.pageTransitionMap;c.buttonEventMap=b.buttonEventMap;delete b.buttonEventMap;_.isEmpty(b.fsCommandMap)||(c.fsCommandMap=b.fsCommandMap);delete b.fsCommandMap;_.isEmpty(b.handler)||(c.handler=b.handler);delete b.handler;c.callback=b.callback;delete b.callback;c.lwfMap=b.lwfMap;delete b.lwfMap;c.fitToScreen=b.fitToScreen;delete b.fitToScreen;this.isLwfsEnvironment_()&&(e=b.prefix?b.prefix+b.lwf:b.lwf,b.prefix=e.slice(0,e.lastIndexOf("/")+1),delete b.imagePrefix,
b.lwf=e.slice(e.lastIndexOf("/")+1));e={position:"absolute",top:0,left:0};_.extend(e,b.pos);delete b.pos;if("static"===a.style.position||""===a.style.position)a.style.position="relative";g=M(g);g.style.position=e.position;g.style.top=e.top+"px";g.style.left=e.left+"px";g.style.zIndex=a.style.zIndex+1;a.appendChild(g);n=null;v?(n=document.createElement("div"),n.style.position="absolute",n.style.top=e.top+"px",n.style.left=e.left+"px",n.style.zIndex=g.style.zIndex+1,a.appendChild(n)):n=g;b.stage=g;
c.stageEventReceiver=n;if(this.debug||c.debug)g=document.createElement("div"),g.id="lwf_info"+B,g.style.position=e.position,g.style.top=e.top+"px",g.style.left=e.left+"px",g.style.color="white",g.style.zIndex=1E4,a.appendChild(g);if(b.lwf){c.useLwfJs=/\.lwf.js(\?.*)?$/.test(b.lwf);if(b.hasOwnProperty("_loaderData"))throw Error("cannot use '_loaderData' property that used by lwf-loader!");b.privateData._loaderData=c;f.loadLWF(b)}else console.error("[LWF] no LWF input")};h.prototype.requestLWF_=function(a,
d,f,g,b){var c={},e={},c={};if(this.isLwfsEnvironment_()){e=_.clone(window.testlwf_settings);e.prefix?c=e.prefix+d+"/_/":(c=document.location.pathname,c=c.replace(a.name,d),c=c.slice(0,c.lastIndexOf("/")+1)+"_/");e.prefix=c;delete e.imagePrefix;c=this.getLwfPath_(d);if(!c)return console.error("[LWF] no LWF input"),b("no LWF input",null),null;e.lwf=c;e.parentLWF=a;e.stage=a.stage;e.worker=z;e.active=!1;f&&(e.imageMap=this.getImageMapper_(f));g&&(e.privateData=g);e.onload=function(a){var c={},c=_.isUndefined(this.privateData)||
_.isUndefined(this.privateData.lwfLoader)?new h:this.privateData.lwfLoader;return a?b(null,a):(c.handleLoadError_(this),b(this.error,a))}}else{e=a.privateData;if("undefined"===typeof e)return console.error("[LWF] Parent private data is not found"),b("no parents data found",null),null;var l=_.clone(e._loaderData);if("undefined"===typeof l)return console.error("[LWF] Parent Loader data is not found"),b("no loader parameters to inherit"),null;e=_.clone(l.setting);this.useAbsImagePath&&(e.imagePrefix=
"");e.fitForHeight=e.fitForWidth=!1;l.setting=e;if(this.isLwfsLoaderEnvironment_())c=document.location.pathname,c=c.replace(a.name,d),c=c.slice(0,c.lastIndexOf("/")+1)+"_/",e.prefix=c,delete e.imagePrefix,c=this.getLwfPath_(d);else{c=null;try{c=this.getLwfMapper_(l)(d)}catch(m){this.handleException_(m,l)}}if(!c)return console.error("[LWF] no LWF input"),b("no LWF input",null),null;e.lwf=c;l.useLwfJs&&(e.lwf+=".js");e.parentLWF=a;e.stage=a.stage;e.worker=z;e.active=!1;f&&(e.imageMap=this.getImageMapper_(f));
g&&(g._loaderData=l,e.privateData=g,g.prefix&&(e.prefix=g.prefix),g.imagePrefix&&(e.imagePrefix=g.imagePrefix));e.onload=function(a){var c=l.loader;return a?b(null,a):(c.handleLoadError_(this,l),b(this.error,a))}}return e};h.prototype.requestLWF=function(a,d,f,g,b){a=this.requestLWF_(a,d,f,g,b);_.isNull(a)||this.requests.push(a)};h.prototype.loadLWF=function(a,h,f,g,b){a=this.requestLWF_(a,h,f,g,b);_.isNull(a)||d.LWF.ResourceCache.get().loadLWF(a)};h.prototype.loadLWFs=function(a){d.LWF.ResourceCache.get().loadLWFs(this.requests,
a);this.requests=[]};h.prototype.unloadLWF=function(a){var h=a.privateData.loaderUid;this.lwfInstances[h]=null;d.cancelAnimationFrame(this.timers[h]);this.timers[h]=null;a.destroy()};d.LwfLoader=h})(window);
